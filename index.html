<!DOCTYPE html>
<!-- Tambahkan translate="no" dan class="notranslate" di sini -->
<html lang="en" translate="no" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <title>Ujian Sekolah (Mode Tryout Support)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --secondary: #4338ca;
            --bg: #f8fafc;
            --text: #1f2937;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --touch-highlight: #e0e7ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; padding: 0; line-height: 1.5;
            user-select: none; -webkit-user-select: none; top: 0 !important;
        }
        .skiptranslate { display: none !important; }

        .container {
            width: 100%; max-width: 600px; margin: 0 auto; background: var(--bg);
            padding: 0 0 80px 0; min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: white; padding: 12px 15px; position: relative; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        .school-logo { width: 45px; height: 45px; object-fit: cover; border-radius: 50%; border: 2px solid var(--border); }
        .header-text h1 { margin: 0; font-size: 1rem; font-weight: 700; line-height: 1.2; }
        .header-text p { margin: 2px 0 0 0; font-size: 0.75rem; color: #64748b; }

        /* DATA DIRI */
        .identity-box {
            background: white; margin: 15px; padding: 20px; border-radius: 12px;
            border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .identity-box h3 { margin-top: 0; font-size: 1.1rem; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 600; color: #475569; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px;
            font-size: 1rem; background: #f8fafc; transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* SOAL CARDS */
        .question-card {
            background: white; margin: 15px; padding: 20px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03); border: 1px solid var(--border);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .question-card.unanswered { border: 2px solid #ef4444; background-color: #fff1f2; }
        .question-text { font-size: 1.05rem; font-weight: 600; margin-bottom: 15px; color: #1e293b; }
        .reading-text {
            background-color: #f1f5f9; border-left: 4px solid var(--primary); padding: 12px;
            margin-bottom: 15px; font-size: 0.95rem; font-style: italic; color: #334155;
            white-space: pre-line; border-radius: 0 8px 8px 0;
        }
        .question-img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border); margin: 10px 0; }

        /* OPSI JAWABAN */
        .options { display: flex; flex-direction: column; gap: 10px; }
        .options label {
            display: flex; align-items: center; padding: 12px 15px; background: #ffffff;
            border: 1px solid #cbd5e1; border-radius: 10px; cursor: pointer;
            transition: all 0.2s; font-size: 0.95rem; min-height: 48px;
        }
        .options label:active { background-color: var(--touch-highlight); transform: scale(0.98); }
        .options input[type="radio"] { width: 20px; height: 20px; margin-right: 12px; accent-color: var(--primary); }
        /* Style huruf opsi (A, B, C...) */
        .opt-label { font-weight: bold; margin-right: 8px; min-width: 20px; color: var(--primary); }
        .options label:has(input:checked) { background-color: #eef2ff; border-color: var(--primary); }

        /* BUTTONS & MODALS */
        .btn-submit {
            display: block; width: calc(100% - 30px); margin: 25px auto; background: var(--primary);
            color: white; border: none; padding: 16px; font-size: 1.1rem; font-weight: bold;
            border-radius: 12px; cursor: pointer; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
            transition: transform 0.1s, background 0.2s;
        }
        .btn-submit:active { transform: scale(0.97); background: var(--primary-dark); }

        #result-area, #locked-screen {
            margin: 20px 15px; padding: 25px 20px; background: white; border-radius: 16px;
            text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        #locked-screen { border: 2px solid #e11d48; background: #fff1f2; }
        
        .result-card {
            background: #f8fafc; border: 1px solid #cbd5e1; padding: 15px;
            border-radius: 12px; margin-top: 15px; text-align: left;
        }
        .result-table td { padding: 8px 0; font-size: 0.95rem; }
        .result-table td:first-child { width: 100px; color: #64748b; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none; justify-content: center;
            align-items: center; z-index: 10000; font-weight: bold; color: var(--primary);
            flex-direction: column;
        }
        
        /* RULE OVERLAY STYLES */
        #rule-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 20000; display: flex; 
            justify-content: center; align-items: center; padding: 20px;
        }
        .rule-box {
            max-width: 500px; width: 100%;
            background: white;
            text-align: center;
        }
        .rule-list {
            text-align: left;
            margin: 20px 0;
            background: #fff1f2;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #fda4af;
        }
        .rule-list li { margin-bottom: 10px; color: #881337; font-weight: 500; }

        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #admin-panel { padding: 15px; background: white; margin-bottom: 50px; display: none; }
        .admin-controls button { display: block; width: 100%; margin-bottom: 10px; padding: 12px; }
        
        /* Empty State */
        .empty-state { text-align: center; color: #94a3b8; padding: 40px 20px; font-style: italic;}
        
        /* Admin Mapel List */
        .mapel-schedule-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #e2e8f0;
        }
        .mapel-schedule-item:last-child { border-bottom: none; }
        .mapel-name { font-weight: 600; font-size: 0.9rem; color: #334155; }
    </style>
</head>
<body oncontextmenu="return false;">

<!-- RULE OVERLAY (PERINGATAN AWAL) -->
<div id="rule-overlay">
    <div class="rule-box">
        <img src="https://cdn-icons-png.flaticon.com/512/1000/1000997.png" alt="Warning" style="width: 80px; margin-bottom: 15px;">
        <h2 style="color: #be123c; margin: 0 0 10px 0;">PERATURAN UJIAN</h2>
        <p style="color: #4b5563;">Harap baca aturan berikut sebelum memulai.</p>
        
        <ul class="rule-list">
            <li>üö´ <b>Dilarang membuka tab lain</b> atau keluar dari aplikasi ini.</li>
            <li>üëÄ Sistem memiliki <b>pendeteksi kecurangan</b> otomatis.</li>
            <li>‚ö†Ô∏è Jika melanggar lebih dari <b>3 kali</b>, jawaban akan dikirim <b>OTOMATIS</b> dan ujian berakhir.</li>
            <li>üíæ Jawaban tersimpan saat <b>Refresh</b>, tapi <b>HILANG</b> jika tab/browser <b>DITUTUP</b>.</li>
        </ul>

        <button onclick="acceptRules()" class="btn-submit" style="background: #059669; margin-top: 0;">
            SAYA MENGERTI & MULAI
        </button>
    </div>
</div>

<div id="loader" class="loading-overlay">
    <div class="spinner"></div>
    <div>Sedang memproses...</div>
</div>

<div class="container">
    <div class="header">
        <div class="header-left">
            <img src="https://raw.githubusercontent.com/atha-cyber/logo-/5eeaaecc00cf02080842f1cd6f4fc7bf13fe7f18/images.jfif" alt="Logo" class="school-logo">
            <div class="header-text">
                <h1>SMP NEGERI 4 PANDAK</h1>
                <p>Ujian Sekolah Terpadu</p>
            </div>
        </div>
    </div>

    <!-- IDENTITAS -->
    <div class="identity-box">
        <h3>üìã Data Diri Siswa</h3>
        
        <div class="form-group" style="background: #e0f2fe; padding: 10px; border-radius: 8px; border: 1px solid #bae6fd;">
            <label style="color: #0284c7;">Pilih Mata Pelajaran & Kelas</label>
            <select id="examLevel" onchange="changeExamLevel(this.value)" style="border-color: #0284c7; font-weight: bold; color: #0369a1;">
                <option value="">-- Pilih Paket Soal --</option>
                
                <optgroup label="Bahasa Indonesia">
                    <option value="7-INDO">Kelas 7 - Bahasa Indonesia</option>
                    <option value="8-INDO">Kelas 8 - Bahasa Indonesia</option>
                    <option value="9-INDO">Kelas 9 - Bahasa Indonesia</option>
                </optgroup>

                <optgroup label="Bahasa Inggris">
                    <option value="7-ING">Kelas 7 - Bahasa Inggris</option>
                    <option value="8-ING">Kelas 8 - Bahasa Inggris</option>
                    <option value="9-ING">Kelas 9 - Bahasa Inggris</option>
                </optgroup>

                <optgroup label="IPA (Ilmu Pengetahuan Alam)">
                    <option value="7-IPA">Kelas 7 - IPA</option>
                    <option value="8-IPA">Kelas 8 - IPA</option>
                    <option value="9-IPA">Kelas 9 - IPA</option>
                </optgroup>

                <optgroup label="IPS (Ilmu Pengetahuan Sosial)">
                    <option value="7-IPS">Kelas 7 - IPS</option>
                    <option value="8-IPS">Kelas 8 - IPS</option>
                    <option value="9-IPS">Kelas 9 - IPS</option>
                </optgroup>

                <optgroup label="PKN (Pendidikan Kewarganegaraan)">
                    <option value="7-PKN">Kelas 7 - PKN</option>
                    <option value="8-PKN">Kelas 8 - PKN</option>
                    <option value="9-PKN">Kelas 9 - PKN</option>
                </optgroup>

                <optgroup label="PJOK (Penjasorkes)">
                    <option value="7-PJOK">Kelas 7 - PJOK</option>
                    <option value="8-PJOK">Kelas 8 - PJOK</option>
                    <option value="9-PJOK">Kelas 9 - PJOK</option>
                </optgroup>
            </select>
        </div>

        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="studentName" placeholder="Nama Lengkap..." autocomplete="off" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Kelas Rinci</label>
                <input type="text" id="studentClass" placeholder="Contoh: 7A / 8B" autocomplete="off" required>
            </div>
            <div class="form-group">
                <label>Absen</label>
                <input type="number" id="studentAbsen" placeholder="No." autocomplete="off" required>
            </div>
        </div>
    </div>

    <form id="examForm" onsubmit="event.preventDefault(); gradeExam();" autocomplete="off">
        <div id="questions-container">
            <div class="empty-state">
                üëÜ Silakan pilih <b>Paket Soal</b> pada kolom di atas untuk memunculkan soal.
            </div>
        </div>
        
        <button type="button" id="btn-done" class="btn-submit" onclick="gradeExam()" style="display:none;">Selesai & Kumpulkan Jawaban</button>
    </form>

    <!-- LAYAR TERKUNCI (HASIL) -->
    <div id="locked-screen" style="display:none;">
        <div style="font-size: 3rem; margin-bottom: 10px;">üîí</div>
        <h2 style="color:#be123c; margin-top:0;">Ujian Selesai!</h2>
        <p style="font-size:1rem; margin-bottom:20px; color: #4b5563;">
            Jawaban Anda telah tersimpan di server.
        </p>
        
        <button onclick="resetSession()" style="background:#059669; color:white; border:none; padding:12px 25px; font-size:1rem; font-weight:bold; border-radius:8px; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%;">
            üîÑ Selesai & Reset (Siswa Baru)
        </button>
    </div>

    <!-- HASIL (HIDDEN) -->
    <div id="result-area" style="display:none;">
        <h2 style="color:var(--primary);">Hasil Ujian</h2>
        <div class="result-card">
            <table class="result-table" style="width:100%;">
                <tr><td>Nama Siswa</td><td>: <span id="res-nama" style="font-weight:600;"></span></td></tr>
                <tr><td>Paket/Kelas</td><td>: <span id="res-kelas"></span></td></tr>
                <tr><td>No. Absen</td><td>: <span id="res-absen"></span></td></tr>
                <tr><td>Nilai Akhir</td><td>: <span id="res-nilai" style="font-weight:bold; color:#059669; font-size:1.4rem;"></span></td></tr>
            </table>
            <div style="margin-top: 15px; border-top: 1px dashed #cbd5e1; padding-top: 10px; font-size: 0.8rem; text-align: center; color: #94a3b8;">
                Validasi: <span id="res-kode" style="font-family: monospace;"></span>
            </div>
        </div>
        <p id="feedback-text" style="font-weight:bold; margin-top:20px;">Nilai Anda belum mencukupi.</p>
        
        <button onclick="resetSession()" style="background:#6b7280; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; margin-top:20px;">
            Keluar & Reset
        </button>
    </div>

    <!-- ADMIN -->
    <div id="admin-panel">
        <div class="admin-controls">
            <h3 style="color:#b91c1c; margin-top:0;">üîê Database Guru</h3>
            
            <!-- SECTION GLOBAL MODE TRYOUT -->
            <div style="background: #ecfdf5; border: 1px solid #6ee7b7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h4 style="margin:0; color: #047857;">üöÄ Mode Tryout (Global)</h4>
                        <small style="color:#065f46;">Abaikan semua jadwal, buka semua soal sekarang.</small>
                    </div>
                    <button id="btn-tryout-toggle" onclick="toggleTryoutMode()" style="padding:10px 20px; border-radius:20px; font-weight:bold; border:none; cursor:pointer; background:#e5e7eb; color:#374151;">Memuat...</button>
                </div>
            </div>

            <!-- SECTION JADWAL -->
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin:0 0 10px 0; color: #0369a1;">üìÖ Atur Jadwal (Per Mata Pelajaran)</h4>
                <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 10px;">Berlaku jika Mode Tryout <b>MATI</b>.</p>
                
                <div id="admin-schedule-list" style="background: white; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 10px;">
                    <div style="padding:10px; text-align:center;">Memuat mapel...</div>
                </div>
            </div>

            <button onclick="downloadCSV()" style="background:#059669; color:white; border:none; border-radius:8px;">üì• Download Excel</button>
            <button onclick="hapusData()" style="background:#dc2626; color:white; border:none; border-radius:8px;">üóëÔ∏è Hapus Semua Data Nilai</button>
            <button onclick="tutupAdmin()" style="background:#6b7280; color:white; border:none; border-radius:8px;">Tutup Panel</button>
        </div>
        <div style="overflow-x:auto; margin-top:15px;">
            <table border="1" style="width:100%; border-collapse:collapse; border-color:#e2e8f0; font-size:0.85rem;">
                <thead><tr style="background:#f1f5f9;"><th style="padding:8px;">Nama</th><th style="padding:8px;">Kls</th><th style="padding:8px;">Nilai</th></tr></thead>
                <tbody id="tabel-nilai"><tr><td colspan='3' style='text-align:center; padding:10px;'>Memuat data...</td></tr></tbody>
            </table>
        </div>
    </div>
    <button onclick="bukaAdmin()" style="position:fixed; bottom:20px; right:20px; background:rgba(255,255,255,0.8); border:1px solid #cbd5e1; font-size:1.5rem; cursor:pointer; border-radius:50%; width:45px; height:45px; z-index:9999; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">üîí</button>
</div>

<!-- LOGIKA APLIKASI -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDy6E0FpxFAV8Fq2ayO1UWd2UMC19xLHgM", 
      authDomain: "vooting-guru.firebaseapp.com",
      projectId: "vooting-guru",
      storageBucket: "vooting-guru.firebasestorage.app",
      messagingSenderId: "643701954972",
      appId: "1:643701954972:web:5db3499faeb8ca91919059",
      measurementId: "G-MZV18MY9VM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // --- KONFIGURASI KOLEKSI ---
    const COLLECTION_NAME = 'exam_results_all_subjects_v2';
    const CONFIG_COLLECTION = 'exam_config'; 
    const SCHEDULE_DOC = 'schedule'; // Satu dokumen untuk semua config jadwal + tryout mode
    const passwordGuru = "!@#$%^&*()"; 

    // --- BANK SOAL LENGKAP ---
    const DATA_BANK_SOAL = {
        
        // ================= BAHASA INGGRIS =================
        "7-ING": [
            { id: 701, tanya: 'The teacher enters the class at 07.00 a.m. What does he say?', opsi: {A: "Good night", B: "Good afternoon", C: "Good morning", D: "Good bye"}, kunci: "C" },
            { id: 702, tanya: 'Andi : "Goodbye, Edo."\nEdo : "...."', opsi: {A: "Thank you", B: "I am fine", C: "Goodbye", D: "You\'re welcome"}, kunci: "C" },
            { id: 703, tanya: 'We sit on the...', opsi: {A: "Table", B: "Chair", C: "Wall", D: "Floor"}, kunci: "B" },
            { id: 704, tanya: 'What is "Merah" in English?', opsi: {A: "Blue", B: "Red", C: "Green", D: "Yellow"}, kunci: "B" },
            { id: 705, tanya: 'My father‚Äôs brother is my...', opsi: {A: "Uncle", B: "Aunt", C: "Grandfather", D: "Brother"}, kunci: "A" }
        ],
        "8-ING": [
            { id: 801, tanya: 'We ... to the library yesterday.', opsi: {A: "Go", B: "Went", C: "Gone", D: "Going"}, kunci: "B" },
            { id: 802, tanya: 'She is the ... student in the class.', opsi: {A: "Smart", B: "Smarter", C: "Smartest", D: "Smartly"}, kunci: "C" },
            { id: 803, tanya: 'Can you ... the piano?', opsi: {A: "Play", B: "Played", C: "Plays", D: "Playing"}, kunci: "A" },
            { id: 804, tanya: 'Does he ... to school by bus?', opsi: {A: "Go", B: "Goes", C: "Going", D: "Went"}, kunci: "A" },
            { id: 805, tanya: 'I was sleeping when my mother ...', opsi: {A: "Call", B: "Calls", C: "Called", D: "Calling"}, kunci: "C" }
        ],
        "9-ING": [
            { id: 901, tanya: 'The room ... by my mother every morning.', opsi: {A: "Is cleaned", B: "Cleans", C: "Cleaned", D: "Was cleaned"}, kunci: "A" },
            { id: 902, tanya: 'If I ... hard, I will pass the exam.', opsi: {A: "Study", B: "Studied", C: "Studies", D: "Studying"}, kunci: "A" },
            { id: 903, tanya: 'Have you ... this movie?', opsi: {A: "See", B: "Saw", C: "Seen", D: "Seeing"}, kunci: "C" },
            { id: 904, tanya: 'The man ... car is red is my uncle.', opsi: {A: "Who", B: "Whom", C: "Whose", D: "Which"}, kunci: "C" },
            { id: 905, tanya: 'He said that he ... busy.', opsi: {A: "Is", B: "Was", C: "Were", D: "Are"}, kunci: "B" }
        ],

        // ================= BAHASA INDONESIA =================
        "7-INDO": [
            { id: 711, tanya: 'Teks yang menggambarkan suatu objek secara rinci disebut teks...', opsi: {A: "Narasi", B: "Deskripsi", C: "Eksposisi", D: "Prosedur"}, kunci: "B" },
            { id: 712, tanya: 'Pantun termasuk dalam jenis puisi...', opsi: {A: "Modern", B: "Baru", C: "Lama", D: "Bebas"}, kunci: "C" },
            { id: 713, tanya: 'Struktur teks deskripsi terdiri atas...', opsi: {A: "Identifikasi, deskripsi bagian, simpulan", B: "Orientasi, komplikasi, resolusi", C: "Tesis, argumen, penegasan ulang", D: "Pembukaan, isi, penutup"}, kunci: "A" },
            { id: 714, tanya: 'Kata "Pantai Parangtritis" harus ditulis dengan huruf kapital karena...', opsi: {A: "Awal kalimat", B: "Nama diri geografi", C: "Nama orang", D: "Judul buku"}, kunci: "B" },
            { id: 715, tanya: 'Majas yang melebih-lebihkan sesuatu disebut...', opsi: {A: "Personifikasi", B: "Hiperbola", C: "Metafora", D: "Litotes"}, kunci: "B" }
        ],
        "8-INDO": [
            { id: 811, tanya: 'Teks yang berisi kabar tentang peristiwa yang sedang terjadi disebut...', opsi: {A: "Iklan", B: "Berita", C: "Slogan", D: "Poster"}, kunci: "B" },
            { id: 812, tanya: 'Kalimat utama dalam sebuah paragraf biasanya terdapat di...', opsi: {A: "Awal atau akhir paragraf", B: "Tengah paragraf", C: "Setiap kalimat", D: "Tidak ada"}, kunci: "A" },
            { id: 813, tanya: 'Tujuan utama dari iklan adalah untuk...', opsi: {A: "Menghibur pembaca", B: "Menceritakan pengalaman", C: "Membujuk khalayak", D: "Menjelaskan prosedur"}, kunci: "C" },
            { id: 814, tanya: 'Unsur ADIKSIMBA dalam berita, huruf \'D\' berarti...', opsi: {A: "Dari mana", B: "Di mana", C: "Dengan siapa", D: "Demi apa"}, kunci: "B" },
            { id: 815, tanya: 'Teks persuasi bersifat...', opsi: {A: "Mengajak", B: "Memerintah", C: "Melarang", D: "Menceritakan"}, kunci: "A" }
        ],
        "9-INDO": [
            { id: 911, tanya: 'Teks yang melaporkan hasil percobaan ilmiah disebut...', opsi: {A: "Teks Laporan Percobaan", B: "Teks Eksplanasi", C: "Teks Prosedur", D: "Teks Eksposisi"}, kunci: "A" },
            { id: 912, tanya: 'Pidato yang bertujuan meyakinkan pendengar disebut pidato...', opsi: {A: "Informatif", B: "Persuasif", C: "Rekreatif", D: "Deskriptif"}, kunci: "B" },
            { id: 913, tanya: 'Unsur intrinsik cerpen yang berkaitan dengan tempat dan waktu adalah...', opsi: {A: "Tema", B: "Alur", C: "Latar", D: "Penokohan"}, kunci: "C" },
            { id: 914, tanya: 'Bagian akhir dari sebuah cerpen yang berisi penyelesaian masalah disebut...', opsi: {A: "Abstrak", B: "Orientasi", C: "Komplikasi", D: "Resolusi"}, kunci: "D" },
            { id: 915, tanya: 'Kata penghubung antarkalimat yang menyatakan pertentangan adalah...', opsi: {A: "Oleh karena itu", B: "Selanjutnya", C: "Akan tetapi", D: "Kemudian"}, kunci: "C" }
        ],

        // ================= IPA (SAINS) =================
        "7-IPA": [
            { id: 721, tanya: 'Satuan Internasional (SI) untuk besaran panjang adalah...', opsi: {A: "Kilometer", B: "Meter", C: "Sentimeter", D: "Milimeter"}, kunci: "B" },
            { id: 722, tanya: 'Zat yang memiliki bentuk dan volume tetap adalah...', opsi: {A: "Padat", B: "Cair", C: "Gas", D: "Plasma"}, kunci: "A" },
            { id: 723, tanya: 'Alat untuk mengukur suhu adalah...', opsi: {A: "Barometer", B: "Termometer", C: "Speedometer", D: "Higrometer"}, kunci: "B" },
            { id: 724, tanya: 'Kelompok makhluk hidup yang dapat membuat makanannya sendiri disebut...', opsi: {A: "Heterotrof", B: "Autotrof", C: "Pengurai", D: "Karnivora"}, kunci: "B" },
            { id: 725, tanya: 'Perubahan wujud dari cair ke gas disebut...', opsi: {A: "Mencair", B: "Membeku", C: "Menguap", D: "Menyublim"}, kunci: "C" }
        ],
        "8-IPA": [
            { id: 821, tanya: 'Gaya yang menahan benda agar tidak tergelincir disebut gaya...', opsi: {A: "Gravitasi", B: "Gesek", C: "Pegas", D: "Magnet"}, kunci: "B" },
            { id: 822, tanya: 'Alat yang termasuk tuas golongan pertama adalah...', opsi: {A: "Gunting", B: "Gerobak roda satu", C: "Pinset", D: "Pembuka botol"}, kunci: "A" },
            { id: 823, tanya: 'Bagian tumbuhan yang berfungsi menyerap air dari tanah adalah...', opsi: {A: "Daun", B: "Batang", C: "Akar", D: "Bunga"}, kunci: "C" },
            { id: 824, tanya: 'Pencernaan kimiawi di lambung dibantu oleh enzim...', opsi: {A: "Amilase", B: "Pepsin", C: "Tripsin", D: "Lipase"}, kunci: "B" },
            { id: 825, tanya: 'Zat aditif yang berfungsi sebagai pengawet adalah...', opsi: {A: "Gula", B: "Garam", C: "Natrium Benzoat", D: "MSG"}, kunci: "C" }
        ],
        "9-IPA": [
            { id: 921, tanya: 'Pembelahan sel yang menghasilkan sel gamet adalah...', opsi: {A: "Mitosis", B: "Meiosis", C: "Amitosis", D: "Sitokinesis"}, kunci: "B" },
            { id: 922, tanya: 'Organ reproduksi pria yang berfungsi menghasilkan sperma adalah...', opsi: {A: "Penis", B: "Skrotum", C: "Testis", D: "Vas deferens"}, kunci: "C" },
            { id: 923, tanya: 'Muatan listrik yang sejenis jika didekatkan akan...', opsi: {A: "Tarik-menarik", B: "Tolak-menolak", C: "Diam", D: "Berputar"}, kunci: "B" },
            { id: 924, tanya: 'Produk bioteknologi konvensional dari kedelai adalah...', opsi: {A: "Keju", B: "Yoghurt", C: "Tempe", D: "Nata de coco"}, kunci: "C" },
            { id: 925, tanya: 'Hewan yang berkembang biak dengan cara bertelur disebut...', opsi: {A: "Vivipar", B: "Ovipar", C: "Ovovivipar", D: "Mamalia"}, kunci: "B" }
        ],

        // ================= IPS (SOSIAL) =================
        "7-IPS": [
            { id: 731, tanya: 'Gambaran permukaan bumi pada bidang datar yang diperkecil disebut...', opsi: {A: "Globe", B: "Atlas", C: "Peta", D: "Sketsa"}, kunci: "C" },
            { id: 732, tanya: 'Nenek moyang bangsa Indonesia berasal dari daerah...', opsi: {A: "Yunan, Tiongkok", B: "India", C: "Arab", D: "Eropa"}, kunci: "A" },
            { id: 733, tanya: 'Kebutuhan yang harus dipenuhi untuk menjaga kelangsungan hidup disebut kebutuhan...', opsi: {A: "Primer", B: "Sekunder", C: "Tersier", D: "Mewah"}, kunci: "A" },
            { id: 734, tanya: 'Kegiatan mengurangi atau menghabiskan nilai guna barang disebut...', opsi: {A: "Produksi", B: "Distribusi", C: "Konsumsi", D: "Investasi"}, kunci: "C" },
            { id: 735, tanya: 'Zaman sebelum manusia mengenal tulisan disebut zaman...', opsi: {A: "Sejarah", B: "Praaksara", C: "Batu", D: "Logam"}, kunci: "B" }
        ],
        "8-IPS": [
            { id: 831, tanya: 'Organisasi perhimpunan negara-negara di Asia Tenggara adalah...', opsi: {A: "PBB", B: "ASEAN", C: "APEC", D: "WHO"}, kunci: "B" },
            { id: 832, tanya: 'Negara ASEAN yang tidak memiliki laut adalah...', opsi: {A: "Thailand", B: "Laos", C: "Vietnam", D: "Kamboja"}, kunci: "B" },
            { id: 833, tanya: 'Perpindahan posisi seseorang dari satu lapisan sosial ke lapisan lain disebut...', opsi: {A: "Interaksi sosial", B: "Konflik sosial", C: "Mobilitas sosial", D: "Status sosial"}, kunci: "C" },
            { id: 834, tanya: 'Kedatangan bangsa Barat ke Indonesia awalnya bertujuan untuk...', opsi: {A: "Berwisata", B: "Mencari rempah-rempah", C: "Menyebarkan agama", D: "Mencari teman"}, kunci: "B" },
            { id: 835, tanya: 'Pelaku ekonomi yang berperan sebagai penyedia faktor produksi adalah...', opsi: {A: "Rumah Tangga Konsumen", B: "Rumah Tangga Produsen", C: "Pemerintah", D: "Masyarakat Luar Negeri"}, kunci: "A" }
        ],
        "9-IPS": [
            { id: 931, tanya: 'Perubahan sosial yang berlangsung cepat disebut...', opsi: {A: "Evolusi", B: "Revolusi", C: "Rotasi", D: "Reformasi"}, kunci: "B" },
            { id: 932, tanya: 'Proses mendunianya suatu hal sehingga batas antarnegara menjadi kabur disebut...', opsi: {A: "Modernisasi", B: "Westernisasi", C: "Globalisasi", D: "Urbanisasi"}, kunci: "C" },
            { id: 933, tanya: 'Benua terluas di dunia adalah benua...', opsi: {A: "Amerika", B: "Afrika", C: "Asia", D: "Eropa"}, kunci: "C" },
            { id: 934, tanya: 'Perdagangan yang dilakukan antarnegara disebut perdagangan...', opsi: {A: "Lokal", B: "Regional", C: "Internasional", D: "Insuler"}, kunci: "C" },
            { id: 935, tanya: 'Masa awal kemerdekaan Indonesia ditandai dengan peristiwa...', opsi: {A: "Sumpah Pemuda", B: "Proklamasi 17 Agustus 1945", C: "Serangan Umum 1 Maret", D: "Bandung Lautan Api"}, kunci: "B" }
        ],

        // ================= PKN (KEWARGANEGARAAN) =================
        "7-PKN": [
            { id: 741, tanya: 'Badan yang merumuskan dasar negara Indonesia adalah...', opsi: {A: "PPKI", B: "BPUPKI", C: "KNIP", D: "DPR"}, kunci: "B" },
            { id: 742, tanya: 'Tanggal 1 Juni diperingati sebagai hari lahir...', opsi: {A: "UUD 1945", B: "Pancasila", C: "Sumpah Pemuda", D: "Kemerdekaan"}, kunci: "B" },
            { id: 743, tanya: 'Aturan yang bersumber dari hati nurani manusia disebut norma...', opsi: {A: "Agama", B: "Kesusilaan", C: "Kesopanan", D: "Hukum"}, kunci: "B" },
            { id: 744, tanya: 'Semboyan Bhinneka Tunggal Ika memiliki arti...', opsi: {A: "Maju terus pantang mundur", B: "Berbeda-beda tetapi tetap satu", C: "Bersatu kita teguh", D: "Merdeka atau mati"}, kunci: "B" },
            { id: 745, tanya: 'Sikap toleransi antarumat beragama merupakan pengamalan Pancasila sila ke...', opsi: {A: "1", B: "2", C: "3", D: "4"}, kunci: "A" }
        ],
        "8-PKN": [
            { id: 841, tanya: 'Hukum dasar tertulis di Indonesia adalah...', opsi: {A: "Pancasila", B: "UUD 1945", C: "Tap MPR", D: "Perpres"}, kunci: "B" },
            { id: 842, tanya: 'Sumpah Pemuda diikrarkan pada tanggal...', opsi: {A: "28 Oktober 1928", B: "17 Agustus 1945", C: "20 Mei 1908", D: "1 Juni 1945"}, kunci: "A" },
            { id: 843, tanya: 'Sila keempat Pancasila dilambangkan dengan...', opsi: {A: "Bintang", B: "Pohon Beringin", C: "Kepala Banteng", D: "Padi dan Kapas"}, kunci: "C" },
            { id: 844, tanya: 'Kedaulatan berada di tangan rakyat dan dilaksanakan menurut UUD. Ini bunyi UUD 1945 pasal...', opsi: {A: "1 ayat 1", B: "1 ayat 2", C: "1 ayat 3", D: "2 ayat 1"}, kunci: "B" },
            { id: 845, tanya: 'Sikap cinta tanah air disebut juga...', opsi: {A: "Patriotisme", B: "Nasionalisme", C: "Chauvinisme", D: "Etnosentrisme"}, kunci: "B" }
        ],
        "9-PKN": [
            { id: 941, tanya: 'Pancasila sebagai ideologi negara bersifat...', opsi: {A: "Kaku", B: "Terbuka", C: "Tertutup", D: "Sementara"}, kunci: "B" },
            { id: 942, tanya: 'Kekuasaan untuk membuat undang-undang disebut kekuasaan...', opsi: {A: "Eksekutif", B: "Legislatif", C: "Yudikatif", D: "Federatif"}, kunci: "B" },
            { id: 943, tanya: 'Lembaga negara yang berwenang melantik Presiden dan Wakil Presiden adalah...', opsi: {A: "DPR", B: "MPR", C: "MK", D: "MA"}, kunci: "B" },
            { id: 944, tanya: 'Sikap rela berkorban demi bangsa dan negara disebut...', opsi: {A: "Nasionalisme", B: "Patriotisme", C: "Separatisme", D: "Radikalisme"}, kunci: "B" },
            { id: 945, tanya: 'Bela negara merupakan hak dan kewajiban...', opsi: {A: "TNI", B: "Polri", C: "Pemerintah", D: "Seluruh warga negara"}, kunci: "D" }
        ],

        // ================= PJOK =================
        "7-PJOK": [
            { id: 751, tanya: 'Induk organisasi sepak bola di Indonesia adalah...', opsi: {A: "PSSI", B: "PBVSI", C: "PERBASI", D: "PBSI"}, kunci: "A" },
            { id: 752, tanya: 'Berapa jumlah pemain satu tim dalam permainan sepak bola?', opsi: {A: "6 orang", B: "5 orang", C: "11 orang", D: "12 orang"}, kunci: "C" },
            { id: 753, tanya: 'Teknik dasar memukul bola dalam permainan bola voli disebut...', opsi: {A: "Passing", B: "Smash", C: "Blocking", D: "Dribbling"}, kunci: "B" },
            { id: 754, tanya: 'Lari jarak pendek disebut juga...', opsi: {A: "Sprint", B: "Marathon", C: "Jogging", D: "Hiking"}, kunci: "A" },
            { id: 755, tanya: 'Posisi awal saat melakukan push-up yang benar adalah...', opsi: {A: "Telentang", B: "Telungkup", C: "Jongkok", D: "Berdiri"}, kunci: "B" }
        ],
        "8-PJOK": [
            { id: 851, tanya: 'Permainan bola basket dimainkan oleh ... pemain setiap timnya.', opsi: {A: "5", B: "6", C: "11", D: "7"}, kunci: "A" },
            { id: 852, tanya: 'Gerakan memantulkan bola ke lantai dalam basket disebut...', opsi: {A: "Shooting", B: "Dribbling", C: "Passing", D: "Rebound"}, kunci: "B" },
            { id: 853, tanya: 'Start yang digunakan dalam lari jarak pendek adalah start...', opsi: {A: "Jongkok", B: "Melayang", C: "Berdiri", D: "Duduk"}, kunci: "A" },
            { id: 854, tanya: 'Induk organisasi pencak silat di Indonesia adalah...', opsi: {A: "PSSI", B: "IPSI", C: "PRSI", D: "PERBASI"}, kunci: "B" },
            { id: 855, tanya: 'Salah satu gaya renang adalah gaya...', opsi: {A: "Kupu-kupu", B: "Capung", C: "Katak", D: "Burung"}, kunci: "A" } 
        ],
        "9-PJOK": [
            { id: 951, tanya: 'Tes untuk mengukur daya tahan jantung dan paru-paru adalah...', opsi: {A: "Lari 12 menit", B: "Sprint 100m", C: "Push up", D: "Sit up"}, kunci: "A" },
            { id: 952, tanya: 'Sikap lilin merupakan salah satu gerakan senam...', opsi: {A: "Irama", B: "Lantai", C: "Aerobik", D: "Alat"}, kunci: "B" },
            { id: 953, tanya: 'Pukulan pertama dalam permainan bulu tangkis disebut...', opsi: {A: "Smash", B: "Lob", C: "Service", D: "Dropshot"}, kunci: "C" },
            { id: 954, tanya: 'Gerakan guling depan sering disebut dengan istilah...', opsi: {A: "Back roll", B: "Forward roll", C: "Tiger sprong", D: "Headstand"}, kunci: "B" },
            { id: 955, tanya: 'Penyakit HIV/AIDS menyerang sistem...', opsi: {A: "Pencernaan", B: "Pernapasan", C: "Kekebalan tubuh", D: "Saraf"}, kunci: "C" }
        ]
    };
    
    // --- LIST MAPEL UNTUK ADMIN (Code Suffix -> Nama Tampilan) ---
    const DATA_MAPEL = {
        "INDO": "Bahasa Indonesia",
        "ING": "Bahasa Inggris",
        "IPA": "Ilmu Pengetahuan Alam (IPA)",
        "IPS": "Ilmu Pengetahuan Sosial (IPS)",
        "PKN": "Pendidikan Kewarganegaraan",
        "PJOK": "PJOK (Penjasorkes)"
    };

    // --- VARIABEL STATE ---
    let currentLevel = ""; 
    let activeQuestions = []; 
    let isExamFinished = false; 
    let violationCount = 0;
    let isRuleAccepted = false;
    const MAX_VIOLATIONS = 3;
    const storage = sessionStorage; 

    // Kunci Storage
    let STORAGE_KEY = 'exam_data_v2'; 
    let ORDER_KEY = 'exam_order_v2';
    const VIOLATION_KEY = 'exam_violations_v2'; 
    const STATUS_KEY = 'exam_status_v2'; 
    const RULE_ACCEPTED_KEY = 'exam_rule_accepted_v2';
    const LEVEL_KEY = 'exam_selected_level_v2'; 

    // INIT
    async function initAuth() {
        try { await signInAnonymously(auth); } 
        catch (error) { console.error("Login gagal", error); }
    }
    initAuth();

    let currentUser = null;
    onAuthStateChanged(auth, (user) => { if(user) currentUser = user; });

    // --- FUNGSI GLOBAL UTAMA ---
    window.acceptRules = function() {
        isRuleAccepted = true;
        document.getElementById('rule-overlay').style.display = 'none';
        storage.setItem(RULE_ACCEPTED_KEY, 'true');
    }

    // --- FUNGSI ADMIN: RENDER LIST JADWAL & STATUS TRYOUT ---
    window.renderAdminScheduleList = async function() {
        const container = document.getElementById('admin-schedule-list');
        const btnTryout = document.getElementById('btn-tryout-toggle');
        container.innerHTML = "<div style='padding:10px;text-align:center;'>Memuat...</div>";
        
        try {
            // Ambil data jadwal + tryout status
            const docRef = doc(db, CONFIG_COLLECTION, SCHEDULE_DOC);
            const docSnap = await getDoc(docRef);
            const data = docSnap.exists() ? docSnap.data() : {};

            // 1. UPDATE TOMBOL TRYOUT
            const isTryoutOpen = data.isTryoutOpen === true;
            if(isTryoutOpen) {
                btnTryout.innerText = "SEDANG AKTIF (MATIKAN)";
                btnTryout.style.backgroundColor = "#059669"; // Green
                btnTryout.style.color = "white";
            } else {
                btnTryout.innerText = "MATI (AKTIFKAN)";
                btnTryout.style.backgroundColor = "#d1d5db"; // Gray
                btnTryout.style.color = "#374151";
            }

            // 2. RENDER JADWAL MAPEL
            container.innerHTML = "";
            for (const [code, name] of Object.entries(DATA_MAPEL)) {
                let val = "";
                if(data[code]) {
                    const d = new Date(data[code]);
                    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                    val = d.toISOString().slice(0, 16);
                }

                container.innerHTML += `
                    <div class="mapel-schedule-item">
                        <div>
                            <div class="mapel-name">${name}</div>
                            <div style="font-size:0.75rem; color:#64748b;">Kode: ${code}</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <input type="datetime-local" id="time-${code}" value="${val}" style="padding:5px; border:1px solid #cbd5e1; border-radius:4px; font-size:0.8rem;">
                            <button onclick="simpanJadwalMapel('${code}')" style="background:#0284c7; color:white; border:none; padding:5px 10px; border-radius:4px; font-size:0.8rem; cursor:pointer;">Set</button>
                        </div>
                    </div>
                `;
            }
        } catch(e) {
            container.innerHTML = `<div style="color:red; padding:10px;">Gagal memuat: ${e.message}</div>`;
        }
    }

    // --- FUNGSI ADMIN: TOGGLE TRYOUT MODE ---
    window.toggleTryoutMode = async function() {
        const btn = document.getElementById('btn-tryout-toggle');
        const isCurrentlyActive = btn.innerText.includes("SEDANG AKTIF");
        const newState = !isCurrentlyActive;

        btn.innerText = "Menyimpan...";
        
        try {
            await setDoc(doc(db, CONFIG_COLLECTION, SCHEDULE_DOC), { isTryoutOpen: newState }, { merge: true });
            // Refresh UI
            renderAdminScheduleList();
            alert(newState ? "MODE TRYOUT AKTIF! Semua soal terbuka." : "MODE TRYOUT MATI. Jadwal berlaku kembali.");
        } catch(e) {
            alert("Gagal update status: " + e.message);
            renderAdminScheduleList(); // Reset UI
        }
    }

    // Simpan jadwal per mapel
    window.simpanJadwalMapel = async function(mapelCode) {
        const timeVal = document.getElementById(`time-${mapelCode}`).value;
        const updateData = {};
        if(timeVal) updateData[mapelCode] = new Date(timeVal).toISOString();
        else updateData[mapelCode] = null; 

        try {
            await setDoc(doc(db, CONFIG_COLLECTION, SCHEDULE_DOC), updateData, { merge: true });
            alert(`Jadwal ${DATA_MAPEL[mapelCode]} Berhasil Disimpan!`);
        } catch(e) {
            alert("Gagal menyimpan jadwal: " + e.message);
        }
    }

    // --- FUNGSI CEK JADWAL (UPDATE: BYPASS JIKA TRYOUT OPEN) ---
    async function checkExamSchedule(levelVal) {
        if(!levelVal) return true; // Safety

        const mapelCode = levelVal.split('-')[1]; 
        
        try {
            const snap = await getDoc(doc(db, CONFIG_COLLECTION, SCHEDULE_DOC));
            if(snap.exists()) {
                const data = snap.data();

                // 1. CEK GLOBAL TRYOUT MODE (BYPASS)
                if(data.isTryoutOpen === true) {
                    return true; // Buka langsung
                }

                // 2. CEK JADWAL SPESIFIK MAPEL
                const startTimeStr = data[mapelCode];
                if(startTimeStr) {
                    const start = new Date(startTimeStr);
                    const now = new Date();
                    
                    if(now < start) {
                        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                        const dateString = start.toLocaleString('id-ID', options);
                        const mapelName = DATA_MAPEL[mapelCode] || mapelCode;

                        document.getElementById('questions-container').innerHTML = `
                            <div style="text-align:center; padding:40px; background:#fff7ed; border-radius:12px; border:1px solid #fdba74;">
                                <h2 style="color:#c2410c; margin-top:0;">‚è≥ Ujian Belum Dimulai</h2>
                                <p style="color:#9a3412;">Mata Pelajaran: <b>${mapelName}</b></p>
                                <p style="color:#9a3412;">Silakan kembali pada:</p>
                                <h3 style="color:#ea580c; margin:10px 0; font-size:1.2rem;">${dateString} WIB</h3>
                                <p style="font-size:0.8rem; color:#7c2d12;">Sistem akan membuka soal secara otomatis.</p>
                            </div>
                        `;
                        document.getElementById('btn-done').style.display = 'none';
                        return false; // Jadwal belum mulai
                    }
                }
            }
        } catch(e) { console.error("Error checking schedule", e); }
        return true; // Aman
    }

    // --- FUNGSI GANTI PAKET SOAL ---
    window.changeExamLevel = async function(levelVal) {
        if(!levelVal) {
            document.getElementById('questions-container').innerHTML = 
                '<div class="empty-state">üëÜ Silakan pilih <b>Paket Soal</b> pada kolom di atas.</div>';
            document.getElementById('btn-done').style.display = 'none';
            currentLevel = "";
            return;
        }

        // 1. CEK JADWAL SPESIFIK MAPEL DULU SEBELUM PROSES
        document.getElementById('questions-container').innerHTML = '<div class="empty-state">‚è≥ Memeriksa akses soal...</div>';
        
        const isOpen = await checkExamSchedule(levelVal);
        
        if(!isOpen) {
             currentLevel = ""; 
             return;
        }

        if(currentLevel !== "" && currentLevel !== levelVal) {
            const confirmChange = confirm("Mengganti paket soal akan mereset jawaban yang sudah diisi. Lanjutkan?");
            if(!confirmChange) {
                document.getElementById('examLevel').value = currentLevel;
                return;
            }
            storage.removeItem(STORAGE_KEY);
            storage.removeItem(ORDER_KEY);
        }

        currentLevel = levelVal;
        storage.setItem(LEVEL_KEY, currentLevel);
        
        activeQuestions = DATA_BANK_SOAL[currentLevel] || [];
        
        if(activeQuestions.length > 0) {
            renderQuestions();
            document.getElementById('btn-done').style.display = 'block';
            loadProgress();
        } else {
            alert("Soal untuk level ini belum tersedia.");
        }
    }

    // --- START APP ---
    function startApp() {
        if(storage.getItem(RULE_ACCEPTED_KEY) === 'true') {
             document.getElementById('rule-overlay').style.display = 'none';
             isRuleAccepted = true;
        }

        const savedViolations = storage.getItem(VIOLATION_KEY);
        if (savedViolations) violationCount = parseInt(savedViolations, 10);

        const savedStatus = storage.getItem(STATUS_KEY);
        if (savedStatus === 'finished') {
            isExamFinished = true;
            document.getElementById('rule-overlay').style.display = 'none'; 
            showLockedScreen();
            return; 
        }

        const savedLevel = storage.getItem(LEVEL_KEY);
        if(savedLevel && DATA_BANK_SOAL[savedLevel]) {
            document.getElementById('examLevel').value = savedLevel;
            changeExamLevel(savedLevel); 
        }
        
        attachSaveListeners();
    }

    // --- UTILS ---
    function shuffleArray(array) {
        let arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // --- ORDERING LOGIC ---
    function getFixedOrder() {
        const savedOrder = storage.getItem(ORDER_KEY);
        if (savedOrder) {
            try {
                const parsed = JSON.parse(savedOrder);
                if(parsed.level === currentLevel) return parsed;
            } catch(e) { }
        }

        const questionOrder = shuffleArray(activeQuestions.map(s => s.id));
        const optionOrders = {};
        activeQuestions.forEach(s => {
            optionOrders[s.id] = shuffleArray(Object.keys(s.opsi));
        });
        
        const newOrder = { questionOrder, optionOrders, level: currentLevel };
        storage.setItem(ORDER_KEY, JSON.stringify(newOrder));
        return newOrder;
    }

    // --- RENDER SOAL ---
    function renderQuestions() {
        if (isExamFinished) return; 
        
        const container = document.getElementById('questions-container');
        container.innerHTML = ""; 

        const order = getFixedOrder();

        order.questionOrder.forEach((qId, index) => {
            const soal = activeQuestions.find(s => s.id === qId);
            if(!soal) return;

            let html = `<div class="question-card" id="card-q${soal.id}">`;
            if(soal.bacaan) html += `<div class="reading-text">${soal.bacaan}</div>`;
            html += `<div class="question-text">${index + 1}. ${soal.tanya}</div>`;
            if(soal.gambar) html += `<img src="${soal.gambar}" class="question-img" onerror="this.style.display='none'">`;
            html += `<div class="options">`;
            
            const opsiKeys = order.optionOrders[soal.id] || Object.keys(soal.opsi);
            const labels = ['A', 'B', 'C', 'D', 'E'];

            opsiKeys.forEach((key, idx) => {
                const textValue = soal.opsi[key];
                const visualLabel = labels[idx];
                html += `
                    <label>
                        <input type="radio" name="q${soal.id}" value="${key}">
                        <span class="opt-label">${visualLabel}.</span>
                        <span>${textValue}</span>
                    </label>
                `;
            });
            
            html += `</div></div>`;
            container.innerHTML += html;
        });
    }

    // --- SAVE & LOAD ---
    window.saveProgress = function() {
        if (isExamFinished) return;
        const formData = {
            nama: document.getElementById('studentName').value,
            kelas: document.getElementById('studentClass').value,
            absen: document.getElementById('studentAbsen').value,
            answers: {}
        };
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            formData.answers[radio.name] = radio.value;
        });
        storage.setItem(STORAGE_KEY, JSON.stringify(formData));
    }

    function loadProgress() {
        if (isExamFinished) return;
        const savedData = storage.getItem(STORAGE_KEY);
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                if(data.nama) document.getElementById('studentName').value = data.nama;
                if(data.kelas) document.getElementById('studentClass').value = data.kelas;
                if(data.absen) document.getElementById('studentAbsen').value = data.absen;
                if(data.answers) {
                    for (const [key, value] of Object.entries(data.answers)) {
                        const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
                        if (radio) radio.checked = true;
                    }
                }
            } catch (e) { }
        }
    }

    function attachSaveListeners() {
        const textInputs = document.querySelectorAll('input[type="text"], input[type="number"]');
        textInputs.forEach(input => input.addEventListener('input', window.saveProgress));
        const container = document.getElementById('questions-container');
        container.addEventListener('change', (e) => {
            if (e.target.type === 'radio') {
                window.saveProgress();
                const card = e.target.closest('.question-card');
                if(card) card.classList.remove('unanswered');
            }
        });
    }

    // --- ANTI CHEAT ---
    document.addEventListener("visibilitychange", function() {
        if (document.hidden && !isExamFinished && isRuleAccepted) {
            violationCount++;
            storage.setItem(VIOLATION_KEY, violationCount);

            let sisa = MAX_VIOLATIONS - violationCount;
            if (violationCount < MAX_VIOLATIONS) {
                alert(`‚ö†Ô∏è PERINGATAN KECURANGAN!\n\nAnda terdeteksi meninggalkan halaman.\nSisa kesempatan: ${sisa}.`);
            } else {
                alert(`‚õî BATAS PELANGGARAN TERCAPAI!\nJawaban dikumpulkan OTOMATIS.`);
                gradeExam();
            }
        }
    });

    // --- RESET ---
    window.resetSession = function() {
        if(confirm("Yakin ingin mereset untuk siswa baru? Data sesi ini akan hilang.")) {
            storage.clear();
            window.location.reload();
        }
    }

    function showLockedScreen() {
        document.querySelector('.header').style.display = 'none';
        document.querySelector('.identity-box').style.display = 'none';
        document.getElementById('examForm').style.display = 'none';
        document.getElementById('locked-screen').style.display = 'block';
    }

    // --- GRADING & SUBMIT ---
    window.gradeExam = async function() {
        if (!auth.currentUser) { alert("Menghubungkan server..."); return; }
        
        if (!currentLevel) { alert("Pilih paket soal terlebih dahulu!"); return; }

        const nama = document.getElementById('studentName').value.trim().toUpperCase();
        const kelasInput = document.getElementById('studentClass').value.trim().toUpperCase();
        const absen = document.getElementById('studentAbsen').value.trim();

        if ((nama === "" || kelasInput === "" || absen === "") && violationCount < MAX_VIOLATIONS) {
            alert("Lengkapi data diri dulu!"); return;
        }

        if (violationCount < MAX_VIOLATIONS) {
            let missed = [];
            document.querySelectorAll('.question-card').forEach(c => c.classList.remove('unanswered'));
            activeQuestions.forEach(soal => {
                if(!document.querySelector(`input[name="q${soal.id}"]:checked`)) {
                    missed.push(soal.id);
                    const el = document.getElementById(`card-q${soal.id}`);
                    if(el) el.classList.add('unanswered');
                }
            });
            if (missed.length > 0) {
                alert(`Masih ada soal yang belum dijawab.`);
                if(missed[0]) document.getElementById(`card-q${missed[0]}`).scrollIntoView({behavior:"smooth", block:"center"});
                return;
            }
        }

        document.getElementById('loader').style.display = 'flex';

        const finalKelas = `${currentLevel} - ${kelasInput}`;
        const finalNama = nama || "PELANGGARAN_NO_NAME";
        const finalAbsen = absen || "0";

        const docId = `${finalNama.replace(/\s+/g, '_')}_${finalKelas.replace(/\s+/g, '')}_${finalAbsen}`;
        const docRef = doc(db, COLLECTION_NAME, docId);

        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { endProcess("Maaf, siswa ini SUDAH mengerjakan ujian ini."); return; }
            
            const q = query(collection(db, COLLECTION_NAME), where('nama', '==', finalNama));
            const querySnapshot = await getDocs(q);
            let dup = false;
            querySnapshot.forEach(d => { if(d.data().kelas === finalKelas) dup = true; });
            if(dup) { endProcess(`Siswa ${finalNama} untuk mapel/kelas ${finalKelas} SUDAH ujian.`); return; }

        } catch (e) {
            alert("Gagal koneksi. Coba lagi.");
            document.getElementById('loader').style.display = 'none';
            return;
        }

        isExamFinished = true;
        storage.setItem(STATUS_KEY, 'finished'); 

        let score = 0;
        activeQuestions.forEach(soal => {
            const el = document.querySelector(`input[name="q${soal.id}"]:checked`);
            if (el && el.value === soal.kunci) score++;
        });
        
        let finalScore = Math.round((score / activeQuestions.length) * 100);
        const r1 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)];
        const r2 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)];
        const kode = `#SEC-${r1}${100-finalScore}${r2}`;

        const dataSiswa = {
            waktu: new Date().toLocaleString(),
            nama: finalNama, 
            kelas: finalKelas, 
            absen: finalAbsen,
            nilai: finalScore, 
            kode: kode,
            level_soal: currentLevel 
        };

        try {
            await setDoc(docRef, dataSiswa);
            storage.removeItem(STORAGE_KEY);
            storage.removeItem(ORDER_KEY);
            storage.removeItem(VIOLATION_KEY);
            storage.removeItem(LEVEL_KEY);
            document.getElementById('examForm').reset();
        } catch(e) {
            alert("Gagal simpan data. Coba lagi."); 
            document.getElementById('loader').style.display = 'none'; 
            isExamFinished = false; 
            return; 
        }

        document.getElementById('loader').style.display = 'none';
        showLockedScreen();

        document.getElementById('res-nama').innerText = finalNama;
        document.getElementById('res-kelas').innerText = finalKelas;
        document.getElementById('res-absen').innerText = finalAbsen;
        document.getElementById('res-nilai').innerText = finalScore;
        document.getElementById('res-kode').innerText = kode;
        
        const fb = document.getElementById('feedback-text');
        if(finalScore >= 70) { fb.innerText = "LULUS"; fb.style.color="green"; }
        else { fb.innerText = "BELUM LULUS"; fb.style.color="red"; }
        window.scrollTo(0,0);
    }

    function endProcess(msg) {
        document.getElementById('loader').style.display = 'none';
        alert(msg);
    }

    // --- ADMIN PANEL ---
    window.bukaAdmin = function() {
        if(!auth.currentUser) return alert("Tunggu sebentar...");
        if(prompt("Password Guru:") === passwordGuru) {
            document.getElementById('admin-panel').style.display = 'block';
            renderTabelNilai();
            renderAdminScheduleList(); 
            document.getElementById('admin-panel').scrollIntoView({behavior:"smooth"});
        }
    }
    window.tutupAdmin = () => document.getElementById('admin-panel').style.display = 'none';

    window.renderTabelNilai = async function() {
        if(!auth.currentUser) return;
        const tbody = document.getElementById('tabel-nilai');
        tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Loading...</td></tr>";
        
        try {
            const snap = await getDocs(collection(db, COLLECTION_NAME));
            let data = [];
            snap.forEach(d => data.push(d.data()));
            if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Kosong</td></tr>"; return; }
            
            data.sort((a,b) => {
                const levelA = a.level_soal || "0";
                const levelB = b.level_soal || "0";
                if(levelA !== levelB) return levelA.localeCompare(levelB);
                return (a.kelas.localeCompare(b.kelas)) || (parseInt(a.absen) - parseInt(b.absen));
            });

            tbody.innerHTML = "";
            data.forEach(d => {
                let mapelCode = d.level_soal || '?';
                let colorBadge = '#64748b'; 

                if(mapelCode.includes('ING')) colorBadge = '#3b82f6'; 
                else if(mapelCode.includes('PJOK')) colorBadge = '#f97316'; 
                else if(mapelCode.includes('IPA')) colorBadge = '#10b981'; 
                else if(mapelCode.includes('IPS')) colorBadge = '#eab308'; 
                else if(mapelCode.includes('PKN')) colorBadge = '#ef4444'; 
                else if(mapelCode.includes('INDO')) colorBadge = '#06b6d4'; 

                tbody.innerHTML += `<tr>
                    <td style="padding:8px; border:1px solid #ddd;">
                        <b>${d.nama}</b><br>
                        <span style="color:white; background:${colorBadge}; font-weight:bold; font-size:0.7rem; padding:2px 6px; border-radius:4px;">${mapelCode}</span> 
                        <small style="color:gray">${d.waktu.split(',')[1]||''}</small>
                    </td>
                    <td style="padding:8px; border:1px solid #ddd;">${d.kelas}</td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;"><b>${d.nilai}</b></td>
                </tr>`;
            });
        } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='3'>Error</td></tr>"; }
    }

    window.hapusData = async function() {
        if(!auth.currentUser) return;
        if(confirm("HAPUS SEMUA DATA PERMANEN?")) {
            document.getElementById('loader').style.display = 'flex';
            const snap = await getDocs(collection(db, COLLECTION_NAME));
            await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
            renderTabelNilai();
            document.getElementById('loader').style.display = 'none';
            alert("Data terhapus.");
        }
    }

    window.downloadCSV = async function() {
        if(!auth.currentUser) return;
        const snap = await getDocs(collection(db, COLLECTION_NAME));
        let data = [];
        snap.forEach(d => data.push(d.data()));
        if(data.length === 0) return alert("Data kosong");
        
        data.sort((a,b) => (a.kelas.localeCompare(b.kelas)) || (parseInt(a.absen) - parseInt(b.absen)));
        
        let csv = "Mapel,Waktu,Nama,Kelas,Absen,Nilai,Kode\n";
        data.forEach(r => csv += `"${r.level_soal||''}","${r.waktu}","${r.nama}","${r.kelas}","${r.absen}",${r.nilai},"${r.kode}"\n`);
        
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'}));
        a.download = `Nilai_Lengkap_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }

    startApp();
    
    setInterval(() => {
        if(document.documentElement.classList.contains('translated-ltr') || document.documentElement.classList.contains('translated-rtl')) {
            alert("Matikan Auto Translate!"); location.reload();
        }
    }, 1000);
</script>
</body>
</html>
